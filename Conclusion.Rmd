---
output: pdf_document
---

# Conclusion {.unnumbered}

This project assessed departure delay from 2008 to 2016. It involved navigation of both the R and Hadoop servers and utilized packages like h2o and rsparkling amongst others. Shiny application was used for initial data visualization. H2O platform was used to perform logistic modeling and deep learning. Logistic regression was performed with binary departure delay indicator variable (categorized by whether or not departure delay was over 30 minutes). In comparison, deep learning was performed with a continuous indicator of departure delay with data filtered for all flights with departure delay greater than 90 minutes. As described in the Deep Learning chapter, criteria of 30 minutes was chosen for logistic regression since it provided an adequate number of observations that either experienced or did not experience departure delay higher than 30 minutes. In comparison, a more stringent criteria of 90 minutes was used to model departure delay in neural network model since the interest was in modeling higher departure delay, which typically results in greater inconvenience. Weather was also assessed via logistic regression. Conceptually, this project explored big data infrastructure of platforms like Hadoop and Apache Spark, algorithms like neural networks and model optimization through grid and random based hyperparameter specification.  

## Limitation
A limitation of this study was that although the original flights dataset had about a million observations, only a sample of about 200,000 observations was copied in the Spark environment. Capacity of Spark can be improved to handle additional data. Parallel computing through the parallel package can be used to split the original data in smaller datasets followed by a computation aggregation.  

## Future Work 
Future extensions of this project can include building data pipelines to dynamically collect and study weather data for the associated flights. Data containing security alerts can also be used to gauge whether flight delays have been associated with increased alerts. Data on computer glitches and technical abnormalities as related to departure delay would also be insightful. Additionally, data on plane manufacturer can be obtained to gauge whether or not the extent of departure delay experienced by a plane is associated with its manufacture information. 

<!--
If you feel it necessary to include an appendix, it goes here.
-->

\appendix

# Appendix

#### Creation of the FullDat dataset (flights data from 2008 to 2016) 
```{r, eval = FALSE}
library(sparklyr)
library(rsparkling)
library(dplyr)
library(h2o)

options(rsparkling.sparklingwater.version = "1.6.8")

sc <-
spark_connect(master = "yarn-client") #connecting to the cluster.
#spark_disconnect(sc) disconnect to cluster

#loading in flights dataset from 2008 to 2016
flights2008 <-
spark_read_csv(
sc,
"flights",
"hdfs:///stats/nycflights
/flights/2008/part-m-*",
header = FALSE,
memory = FALSE
)
flights2009 <-
spark_read_csv(
sc,
"flights",
"hdfs:///stats/nycflights
/flights/2009/part-m-*",
header = FALSE,
memory = FALSE
)
flights2010 <-
spark_read_csv(
sc,
"flights",
"hdfs:///stats/nycflights
/flights/2010/part-m-*",
header = FALSE,
memory = FALSE
)
flights2011 <-
spark_read_csv(
sc,
"flights",
"hdfs:///stats/nycflights
/flights/2011/part-m-*",
header = FALSE,
memory = FALSE
)
flights2012 <-
spark_read_csv(
sc,
"flights",
"hdfs:///stats/nycflights
/flights/2012/part-m-*",
header = FALSE,
memory = FALSE
)
flights2013 <-
spark_read_csv(
sc,
"flights",
"hdfs:///stats/nycflights
/flights/2013/part-m-*",
header = FALSE,
memory = FALSE
)
flights2014 <-
spark_read_csv(
sc,
"flights",
"hdfs:///stats/nycflights
/flights/2014/part-m-*",
header = FALSE,
memory = FALSE
)
flights2015 <-
spark_read_csv(
sc,
"flights",
"hdfs:///stats/nycflights
/flights/2015/part-m-*",
header = FALSE,
memory = FALSE
)
flights2016 <-
spark_read_csv(
sc,
"flights",
"hdfs:///stats/nycflights
/flights/2016/part-m-*",
header = FALSE,
memory = FALSE
)

#Columns were named
flights2008 <- flights2008 %>%
rename(year = V1) %>%
rename(month = V2) %>%
rename(day = V3) %>%
rename(dep_time = V4) %>%
rename(sched_dep_time = V5) %>%
rename(dep_delay = V6) %>%
rename(arr_time = V7) %>%
rename(sched_arr_time = V8) %>%
rename(arr_delay = V9) %>%
rename(carrier = V10) %>%
rename(tailnum = V11) %>%
rename(flight = V12) %>%
rename(origin = V13) %>%
rename(dest = V14) %>%
rename(air_time = V15) %>%
rename(distance = V16) %>%
rename(hour = V18) %>%
rename(minute = V19) %>%
rename(time_hour = V20)

#repeat this step for 2009-2016.
save(flights2008, file = "Flights08.Rda")

load("Flights08.Rda")
load("Flights09.Rda")
load("Flights10.Rda")
load("Flights11.Rda")
load("Flights12.Rda")
load("Flights13.Rda")
load("Flights14.Rda")
load("Flights15.Rda")
load("Flights16.Rda")

FinalDat <- rbind(
DatNew08,
DatNew09,
DatNew10,
DatNew11,
DatNew12,
DatNew13,
DatNew14,
DatNew15,
DatNew16
)
save(FinalDat, file = "FinalDataYear.Rda")
```

#### H2O Logistic Regression 
```{r, eval = FALSE}
library(sparklyr)
library(rsparkling)
library(dplyr)
library(h2o)

options(rsparkling.sparklingwater.version = "1.6.8")
sc <- spark_connect(master = "yarn-client")

log <- load("FullLogData.Rda")
datlog <- FullDatLog

DatNew <- FullDatLog
DatNew$hour <- hour(as.POSIXct(DatNew$time_hour))
DatNew$week <- weekdays(as.Date(DatNew$time_hour))
DatNew$hour <- as.numeric(DatNew$hour)
DatNew$hour <- as.factor(DatNew$hour)
DatNew$weekend <- ifelse(DatNew$week %in% c("Saturday", "Sunday"),
"weekend", "weekday")
data3 <- DatNew
data3$carrier <- as.character(data3$carrier)


data3$weekend <- as.factor(data3$weekend)
data3$week <- as.factor(data3$week)
data3$carrier <- as.factor(data3$carrier)
data3$month <- as.factor(data3$month)
data3$month <- plyr::mapvalues(
data3$month,
from = c("1", "2", "3",
"4", "5", "6",
"7", "8", "9",
"10", "11", "12"),
to = c(
"January",
"February",
"March",
"April",
"May",
"June",
"July",
"August",
"September",
"October",
"November",
"December"
)
)
data3$season <- ifelse(
data3$month %in% c("March", "April", "May"),
"spring",
ifelse(
data3$month %in% c("June", "July",
"August"),
"summer",
ifelse(
data3$month %in% c("September",
"October",
"November"),
"fall",
"winter"
)
)
)

data3$season <- as.factor(data3$season)
data3$year <- as.factor(data3$year)
FullDatLog <- data3

FullDatLog$year <- as.factor(FullDatLog$year)
FullDatLog$dep_delayIn = ifelse(FullDatLog$dep_delay > 30, "Yes", "No")
FullDatLog$dep_delayIn <- as.factor(FullDatLog$dep_delayIn)
FullDatLog1 <- FullDatLog[c(1, 2, 9, 10, 15, 16, 18, 21, 22, 23, 24)]

FullDatLog <- FullDatLog1
save(FullDatLog, file = "HadoopLogMod.Rda")

FullDatLog2 <- load("HadoopLogMod.Rda")
set.seed(134)
sampled <-
FullDatLog[sample(nrow(FullDatLog), 200000, replace = FALSE,
prob = NULL), ]

mtcars_tbl <- copy_to(sc, sampled, "LogData", overwrite = TRUE)
partitions <- mtcars_tbl %>%
sdf_partition(training = 0.75,
test = 0.25,
seed = 1099)

training <- as_h2o_frame(sc, partitions$training)
test <- as_h2o_frame(sc, partitions$test)

training$dep_delayIn <- as.factor(training$dep_delayIn)
training$season <- as.factor(training$season)
training$week <- as.factor(training$week)
training$weekend <- as.factor(training$weekend)
training$carrier <- as.factor(training$carrier)
training$hour <- as.factor(training$hour)
training$month <- as.factor(training$month)
training$year <- as.factor(training$year)


test$dep_delayIn <- as.factor(test$dep_delayIn)
test$season <- as.factor(test$season)
test$week <- as.factor(test$week)
test$weekend <- as.factor(test$weekend)
test$carrier <- as.factor(test$carrier)
test$hour <- as.factor(test$hour)
test$month <- as.factor(test$month)
test$year <- as.factor(test$year)

myX = setdiff(colnames(training),
c("dep_delayIn", "orig_id", "hour",
"month", "weekend"))

regmod <- h2o.glm(
y = "dep_delayIn",
x = myX,
training_frame = training,
family = "binomial",
alpha = 0.1,
lambda_search = FALSE,
nfolds = 5
)

h2o.performance(regmod)
h2o.varimp(regmod)
h2o.varimp_plot(regmod, num_of_features = 20)
mat <- h2o.confusionMatrix(regmod)
#model accuracy
(mat$No[1] + mat$Yes[2]) / (mat$No[1] + mat$No[2] + 
                              mat$Yes[1] + mat$Yes[2])

pred <- h2o.predict(object = regmod, newdata = test)
mean(pred$predict == test$dep_delayIn)
plot(h2o.performance(regmod))

#Weather Logistic Regression

flights$hour <- ifelse(flights$hour == 24, 0, flights$hour)
flights_weather <- left_join(flights, weather)
flights_weather$total <- flights_weather$dep_delay +
flights_weather$arr_delay
flights_weather2 <- filter(flights_weather, total > 0)

DatNew <- flights_weather2
DatNew$hour <- hour(as.POSIXct(DatNew$time_hour))
DatNew$week <- weekdays(as.Date(DatNew$time_hour))
DatNew$hour <- as.numeric(DatNew$hour)
DatNew$hour <- as.factor(DatNew$hour)
DatNew$weekend <- ifelse(DatNew$week %in% c("Saturday", "Sunday"),
"weekend", "weekday")
DatNew$month <- as.factor(DatNew$month)
DatNew$month <-
plyr::mapvalues(
DatNew$month,
from = c("1", "2", "3",
"4", "5", "6",
"7", "8", "9",
"10", "11", "12"),
to = c(
"January",
"February",
"March",
"April",
"May",
"June",
"July",
"August",
"September",
"October",
"November",
"December"
)
)
DatNew$season <-
ifelse(
DatNew$month %in% c("March", "April", "May"),
"spring",
ifelse(
DatNew$month %in% c("June", "July",
"August"),
"summer",
ifelse(
DatNew$month %in% c("September",
"October", "November"),
"fall",
"winter"
)
)
)

flights_weather2 <- DatNew
save(flights_weather2, file = "flights_weather22.Rda")

load("flights_weather22.Rda")
head(flights_weather2)
names(flights_weather2)
nrow(flights_weather2)
flights2 <- na.omit(flights_weather2)

mtcars_tbl <- copy_to(sc, flights2, "flights", overwrite = TRUE)
partitions <- mtcars_tbl %>%
sdf_partition(training = 0.75,
test = 0.25,
seed = 1099)

training <- as_h2o_frame(sc, partitions$training)
test <- as_h2o_frame(sc, partitions$test)

training$dep_delayIn <- ifelse(training$dep_delay > 30, "Yes", "No")
test$dep_delayIn <- ifelse(test$dep_delay > 30, "Yes", "No")

training$dep_delayIn <- as.factor(training$dep_delayIn)
training$season <- as.factor(training$season)
training$week <- as.factor(training$week)
training$weekend <- as.factor(training$weekend)
training$carrier <- as.factor(training$carrier)
training$hour <- as.factor(training$hour)
training$month <- as.factor(training$month)
training$year <- as.factor(training$year)
training$day <- as.factor(training$day)

test$dep_delayIn <- as.factor(test$dep_delayIn)
test$season <- as.factor(test$season)
test$week <- as.factor(test$week)
test$weekend <- as.factor(test$weekend)
test$carrier <- as.factor(test$carrier)
test$hour <- as.factor(test$hour)
test$month <- as.factor(test$month)
test$year <- as.factor(test$year)
test$day <- as.factor(test$day)

testDat <- test[, c(1, 2, 3, 9, 10, 15, 16, 17, 20, 21, 22,
23, 24, 25, 26, 27, 28, 30, 31, 32, 33)]
trainDat <- training[, c(1, 2, 3, 9, 10, 15, 16, 17, 20, 21, 22,
23, 24, 25, 26, 27, 28, 30, 31, 32, 33)]

myX = setdiff(colnames(testDat), c("dep_delayIn"))
regmod <- h2o.glm(
y = "dep_delayIn",
x = myX,
training_frame = trainDat,
family = "binomial",
alpha = 0.1,
lambda_search = FALSE,
nfolds = 5
)

regmodWeather <- regmod
h2o.performance(regmodWeather)
h2o.varimp(regmod)
h2o.varimp_plot(regmodWeather, num_of_features = 30)
h2o.confusionMatrix(regmodWeather)
(mat$No[1] + mat$Yes[2]) / (mat$No[1] + mat$No[2] + 
                              mat$Yes[1] + mat$Yes[2])

pred <- h2o.predict(object = regmodWeather, newdata = testDat)
mean(pred$predict == testDat$dep_delayIn) #accuracy of test set
```


#### H2O Deep Learning 
```{r, eval = FALSE}
library(sparklyr)
library(rsparkling)
library(dplyr)
library(h2o)

 
options(rsparkling.sparklingwater.version = "1.6.8")
#spark_disconnect(sc)
sc <- spark_connect(master = "yarn-client") 

yas <- load("FinalDataYear.Rda")
head(FinalDat)
nrow(FinalDat)
unique(FinalDat$year)

DatNew <- FinalDat
DatNew$hour <- hour(as.POSIXct(DatNew$time_hour))
DatNew$week <- weekdays(as.Date(DatNew$time_hour))
DatNew$hour <- as.numeric(DatNew$hour)
DatNew$hour <- as.factor(DatNew$hour)
DatNew$weekend<- ifelse(DatNew$week %in% c("Saturday", "Sunday"), 
                        "weekend","weekday")
data3 <- DatNew
data3$carrier <- as.character(data3$carrier)


data3$weekend <- as.factor(data3$weekend)
data3$week <- as.factor(data3$week)
data3$carrier <- as.factor(data3$carrier)
data3$month <- as.factor(data3$month)
data3$month <- plyr::mapvalues(data3$month, 
                               from = c("1", "2", "3", 
                                        "4", "5", "6", 
                                        "7", "8", "9", 
                                        "10", "11", "12"), 
                      to = c("January", "February", "March", 
                            "April", "May", "June", "July", 
                            "August", "September", 
                            "October", "November", "December"))
data3$season <- ifelse(data3$month %in% c("March", "April", "May"), 
                       "spring", 
                       ifelse(data3$month %in% c("June", "July", 
                                                 "August"), 
                              "summer", 
                              ifelse(data3$month %in% c("September", 
                                                        "October", 
                                                        "November"), 
                                     "fall", "winter")))

data3$season <- as.factor(data3$season)
data3$year <- as.factor(data3$year)
FullDatLog <- data3
FullDatLog$year <- as.factor(FullDatLog$year)
FullDatLog$dep_delay <- as.numeric(FullDatLog$dep_delay)
nrow(FullDatLog)

set.seed(12) 
sampled <- FullDatLog[sample(nrow(FullDatLog), 
                              200000, replace = FALSE, prob = NULL),]
mtcars_tbl <- copy_to(sc, sampled, "deep", overwrite = TRUE)  
partitions <- mtcars_tbl %>%
  sdf_partition(training = 0.5, validation = 0.25, 
                test = 0.25, seed = 1099)

training <- as_h2o_frame(sc, partitions$training)
validation <- as_h2o_frame(sc, partitions$validation)
test <- as_h2o_frame(sc, partitions$test)

training$dep_delay <- as.numeric(training$dep_delay)
training$arr_delay <- as.numeric(training$arr_delay)
training$air_time <- as.numeric(training$air_time)
training$season <- as.factor(training$season)
training$week <- as.factor(training$week)
training$weekend <- as.factor(training$weekend)
training$carrier <- as.factor(training$carrier)
training$hour <- as.factor(training$hour)
training$month <- as.factor(training$month)
training$year <- as.factor(training$year)

validation$dep_delay <- as.numeric(validation$dep_delay)
validation$arr_delay <- as.numeric(validation$arr_delay)
validation$air_time <- as.numeric(validation$air_time)
validation$season <- as.factor(validation$season)
validation$week <- as.factor(validation$week)
validation$weekend <- as.factor(validation$weekend)
validation$carrier <- as.factor(validation$carrier)
validation$hour <- as.factor(validation$hour)
validation$month <- as.factor(validation$month)
validation$year <- as.factor(validation$year)

test$dep_delay <- as.numeric(test$dep_delay)
test$arr_delay <- as.numeric(test$arr_delay)
test$air_time <- as.numeric(test$air_time)
test$season <- as.factor(test$season)
test$week <- as.factor(test$week)
test$weekend <- as.factor(test$weekend)
test$carrier <- as.factor(test$carrier)
test$hour <- as.factor(test$hour)
test$month <- as.factor(test$month)
test$year <- as.factor(test$year)

training <- training[,c(1,2,6,9,10,15,16,18,21,22,23)]
test <- test[,c(1,2,6,9,10,15,16,18,21,22,23)]
validation <- validation[,c(1,2,6,9,10,15,16,18,21,22,23)]

myX = setdiff(colnames(training), ("dep_delay"))

#First simplified deep learning model 
m1 <- h2o.deeplearning(
  y="dep_delay",
  x=myX,
  activation="Tanh",  
  training_frame=training, 
  validation_frame=validation,
  epochs=1,
  variable_importances=T,    
  nfolds = 5,
  keep_cross_validation_predictions=T
)

deepmod <- m1
h2o.performance(deepmod, train = TRUE)  
h2o.performance(deepmod, valid = TRUE) 
h2o.performance(deepmod, newdata = test)
h2o.varimp_plot(deepmod, num_of_features = 20)

#Grid search model iteration 
hyper_params <- list(
  activation=c("Tanh", "TanhWithDropout"),
  hidden=list(c(20,20),c(40,40)),
  input_dropout_ratio=c(0,0.05),
  rate=c(0.01,0.02,0.03)
)

grid <- h2o.grid(
  algorithm="deeplearning",
  grid_id="gridDeep", 
  training_frame=training,
  validation_frame=validation,
  y="dep_delay",
  x=myX,
  epochs=10,
  stopping_metric="MSE",
  stopping_tolerance=2e-2,        
  stopping_rounds=2, 
  score_duty_cycle=0.025,         
  adaptive_rate=T,                
  momentum_start=0.5,             
  momentum_stable=0.9, 
  momentum_ramp=1e7,
  variable_importances=T,
  l1=1e-5,                         
  l2=1e-5,
  max_w2=10, 
  hyper_params=hyper_params
)

for (model_id in grid@model_ids) { #print model MSE
  model <- h2o.getModel(model_id)
  mse <- h2o.mse(model, valid = TRUE) 
  print(sprintf("Validation set MSE: %f", mse))
}
grid@summary_table[1,] 
optimal <- h2o.getModel(grid@model_ids[[1]]) 

optimal@allparameters #print all parameters of best model 
h2o.performance(optimal, train = TRUE) #retrieve training MSE
h2o.performance(optimal, valid = TRUE) #retrieve validation MSE
h2o.performance(optimal, newdata = test) #retrieve test MSE 

h2o.varimp_plot(optimal, num_of_features = 20)

#Random grid search model 
hyper_params <- list(
  activation=c("Tanh","TanhWithDropout"),
  hidden=list(c(20,20),c(30,30,30),c(40,40,40),
              c(50,50),c(70,70)),
  input_dropout_ratio=c(0,0.05),
  rate=c(0.01,0.02,0.03),
  l1=seq(0,1e-4,1e-6),
  l2=seq(0,1e-4,1e-6)
)

search_criteria = list(strategy = "RandomDiscrete", 
                       max_runtime_secs = 600, 
                       max_models = 100, 
                       seed=22, stopping_rounds=5, 
                       stopping_tolerance=2e-2)

random_grid <- h2o.grid(
  algorithm="deeplearning",
  grid_id = "Gridrandom6_model_6",
  training_frame=training,
  validation_frame=validation, 
  x=myX, 
  y="dep_delay",
  epochs=10,
  stopping_metric="MSE",
  stopping_tolerance=2e-2,        
  stopping_rounds=2,
  score_validation_samples=10000, 
  score_duty_cycle=0.025,         
  max_w2=10,                      
  hyper_params = hyper_params,
  search_criteria = search_criteria
)

for (model_id in grid@model_ids) {
  model <- h2o.getModel(model_id)
  mse <- h2o.mse(model, valid = TRUE) 
  sprintf("Validation set MSE: %f", mse)
}

#Retrieve optimal model by MSE
grid@summary_table[1,] 
optimal <- h2o.getModel(grid@model_ids[[1]]) 

optimal@allparameters #print all parameters of best model 
h2o.performance(optimal, train = TRUE) #retrieve training MSE
h2o.performance(optimal, valid = TRUE) #retrieve validation MSE
h2o.performance(optimal, newdata = test) #retrieve test MSE 

h2o.varimp_plot(optimal, num_of_features = 20)

DeepMod <- h2o.saveModel(optimal, path = "/home/ajavaid17", 
                         force = FALSE)
randomModel <- h2o.loadModel(path = "/home/ajavaid17/DeepLearning_
                             model_R_1487567612904_2")

#Checkpoint continuation from random model
max_epochs <- 20 
checkpoint <- h2o.deeplearning(
  model_id="GridModRandom_continued2", 
  activation="Tanh",
  checkpoint="Gridrandom6_model_6", 
  training_frame=training, 
  validation_frame=validation, 
  y="dep_delay",
  x=myX, 
  hidden=c(30,30,30),          
  epochs=max_epochs,              
  stopping_metric="MSE",     
  stopping_tolerance=2e-2,       
  stopping_rounds=2,
  score_duty_cycle=0.025,         
  adaptive_rate=T,                
  l1=1e-4,                        
  l2=1e-4,
  max_w2=10,
  rate = 0.02,
  variable_importances=T
) 

spark_disconnect(sc) 
h2o.shutdown(prompt=FALSE) 
```


#### Shiny Application Code 
```{r, eval = FALSE}

library(shiny)
library(plyr)
library(dplyr)
library(mosaic)
library(base)
library(plotly)
library(ggplot2)
library(nycflights13)
library(lubridate)
library(igraph)
require(visNetwork)
library(gridExtra)
library(grid)
library(leaflet)
library(ggthemes)

load("fullDivision.Rda")
load("data3N.Rda")
load("data2N.Rda")
load("USAirSum32N.Rda")
load("stateDelay.Rda")

data(flights)
data(weather)

ui <- navbarPage("Flights Analysis", inverse = TRUE,
                 tabPanel("Table Summary",
                          sidebarLayout(
                            sidebarPanel(
                              
                  tags$head(
                      tags$style(HTML("
                        body {
                        background-color: #663399;
                        color: #330033;
                        }
                        "))
                  ),
                              
                              
    selectInput("origin", "Choose a origin airport:",
            choices = sort(unique(data2$OriginAirport)), 
            selected = "John F. Kennedy International Airport"),
                              
    selectInput("destination", "Choose a destination airport:",
            choices = sort(unique(data2$DestAirport)), 
            selected = "San Francisco International Airport"),
                              
    actionButton("go1", "Airport Flights Data", 
  style="color: #ffffff;background-color: #663399;margin: 4px;"),
                              
    selectInput("originState", "Choose a origin state:",
            choices = sort(unique(data2$OriginFState)), 
            selected = "New York"),
                              
    selectInput("destState", "Choose a destination state:",
            choices = sort(unique(data2$DestFState)), 
            selected = "California"),
                              
    actionButton("go2", "State Flights Data", 
 style="color: #ffffff;background-color: #663399;margin: 4px;"),
                              
        HTML('<br/>', '<br/>'),
                              
  strong("Table shows the mean departure delay in minutes 
  from 2008-2016 for all flights with departure delay greater 
  than 90 minutes with the specified origin and destination airport. 
  Alternatively, origin and destination states can also be 
  specified."), width = 3
                              ),
                            mainPanel(
                              dataTableOutput("view"),
                              verbatimTextOutput("avgDelayState"),
                              dataTableOutput("view2")
                            )
                            )
                 ),
                 
                 tabPanel("Paths Analysis",
                          sidebarLayout(
                            sidebarPanel(
                              selectInput("responseP", "Choose a 
                            response predictor:",
                              choices = as.character(c(2008, 
            2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016))),
                              
            selectInput("responseP2", "Choose an Origin state:",
        choices = sort(as.character(unique(group12$OriginFState))), 
        "New York"),
            selectInput("responseP3", "Choose a Destination state:",
        choices = sort(as.character(unique(group12$DestFState))), 
        "California"),
        actionButton("go111", "Departure Delays Mapping", style="color:
                     #ffffff;background-color: #663399;margin: 4px;"),
          br(),
      strong("Map shows the average departure delay in minutes from 
2008-2016 for all United States flights with departure delay greater 
than 90 minutes. Click a point to display airport level departure delay."),
width = 3
            ),
        mainPanel(
          leafletOutput("map4"),
          dataTableOutput("lat")
            )
            )
            ),
  navbarMenu("Delay by State, Division and Region from 2008-2016",
      tabPanel("State",
        sidebarLayout(
          sidebarPanel(
          selectInput("stateDest", "Choose a state:",
            choices = sort(as.character(unique(group12$OriginFState))),
            "New York"),
                br(),
          strong("Top plot shows departure delay in minutes for all
airports in the specified state from 2008-2016 for all flights with 
departure delay greater than 90 minutes. Bottom plot displays the 
aggregate departure delay for the specified state from 2008-2016."), 
width = 2
          ),
                mainPanel(
                  plotlyOutput('plot31'),
                  plotlyOutput('plot32')
                  )
                  )
                  ),       
              tabPanel("Midwest",
                sidebarLayout(
                  sidebarPanel(
                    strong("Top pair of plots shows average 
departure delay in minutes for Midwestern United States over 2008-2016. 
Bottom pair of plots shows aggregated departure delay from 2008 to 2016. 
Left graph in both pairs corresponds to East North Central while right 
graph corresponds to West North Central."), width = 0.5
                      ),
                      mainPanel(
                        plotlyOutput('plot34'),
                        plotlyOutput('plot35'), width = 12.5
                        )
                    )
                  ),
                  tabPanel("Northeast",
                           sidebarLayout(
                             sidebarPanel(
                    strong("Top pair of plots shows average 
departure delay in minutes for Northeastern United States 
over 2008-2016. Bottom pair of plots shows aggregated 
departure delay from 2008 to 2016. Left graph in both 
pairs corresponds to Middle Atlantic while right 
graph corresponds to New England."), width = 0.5
                               ),
                             mainPanel(
                               plotlyOutput('plot36'),
                               plotlyOutput('plot37'), width = 12.5
                             )
                               )
                           ),
                tabPanel("South",
                  sidebarLayout(
                    sidebarPanel(
                      strong("Top three plots shows average 
departure delay in minutes for Southern United States over 
2008-2016. Bottom three plots show aggregated departure delay 
from 2008 to 2016. Left graph in both trios corresponds to 
East South Central, middle graph corresponds to 
West South Central and right graph to South Atlantic."), 
width = 0.5
          ),
          mainPanel(
              plotlyOutput('plot38'),
              plotlyOutput('plot39'), width = 12.5
                    )
                  )
                ),
                tabPanel("West",
                  sidebarLayout(
                    sidebarPanel(
                      strong("Top pair of plots shows average 
departure delay in minutes for Western United States over 2008-2016. 
Bottom pair of plots shows aggregated departure delay from 2008 
to 2016. Left graph in both pairs corresponds to Pacific region while 
right graph corresponds to Mountain region."), width = 0.5
                             ),
                           mainPanel(
                             plotlyOutput('plot40'),
                             plotlyOutput('plot41'), width = 12.5
                           )
                             )
                         )
                ),
navbarMenu("Delay by State and Region by Time and Carrier",
tabPanel("Delay by Hour",
  sidebarLayout(
    sidebarPanel(
      selectInput("stateDest21", "Choose a state:",
        choices = sort(as.character(unique(group18$OriginFState))), 
        "New York"),
        strong("Specify state to observe departure delay by hour and 
    region and aggregated departure delay for specified state from 2008 
    to 2016."), width = 2
                    ),
                  mainPanel(
                    plotlyOutput('plot61'),
                    plotlyOutput('plot42'), width = 10
                          )
                          )
                        ),
                  tabPanel("Day of Week",
                      sidebarLayout(
                        sidebarPanel(
                        selectInput("stateDest22", "Choose a state:",
    choices = sort(as.character(unique(group18$OriginFState))), 
    "New York"),
            strong("Departure delay by week."), width = 2
                  ),
                  mainPanel(
                      plotlyOutput('plot43'),
                      plotlyOutput('plot44')
                            )
                            )
                           ),
              tabPanel("Weekend Status",
                  sidebarLayout(
                    sidebarPanel(
                  selectInput("stateDest23", "Choose a state:",
    choices = sort(as.character(unique(group18$OriginFState))), 
    "New York"),
        strong("Departure delay by weekend status."), width = 2
              ),
              mainPanel(
                  plotlyOutput('plot45'),
                  plotlyOutput('plot46')
                      )
                    )
                  ),
              tabPanel("Month",
                  sidebarLayout(
                    sidebarPanel(
                    selectInput("stateDest24", "Choose a state:",
    choices = sort(as.character(unique(group18$OriginFState))), 
    "New York"),
        strong("Departure delay by month."), width = 2
            ),
                mainPanel(
                    plotlyOutput('plot47'),
                    plotlyOutput('plot48')
                      )
                    )
                  ),
              tabPanel("Season",
                  sidebarLayout(
                    sidebarPanel(
                    selectInput("stateDest25", "Choose a state:",
      choices = sort(as.character(unique(group18$OriginFState))), 
      "New York"),
          strong("Departure delay by season."), width = 2
            ),
                mainPanel(
                   plotlyOutput('plot49'),
                   plotlyOutput('plot50')
                      )
                    )
                  ),
              tabPanel("Carrier",
                  sidebarLayout(
                    sidebarPanel(
                    selectInput("stateDest26", "Choose a state:",
      choices = sort(as.character(unique(group18$OriginFState))), 
      "New York"),
          strong("Departure delay by carrier."), width = 0.5
            ),
                 mainPanel(
                    plotlyOutput('plot51'),
                    plotlyOutput('plot52'), width = 12
                      )
                    )
                  )
                ),
    tabPanel("Aggregate Delay by Region",
        sidebarLayout(
          sidebarPanel(
            selectInput("responseM", "Choose a response predictor:",
        choices = as.character(c(2008, 2009, 2010, 2011, 2012, 
                                 2013, 2014, 2015, 2016))),
        selectInput("responseM2", "Choose a US region:",
          choices = sort(as.character(c("East North Central", 
                                        "East South Central",
                          "Middle Atlantic", "Mountain", 
                          "New England", "Pacific",
                          "South Atlantic",
                          "West North Central", 
                          "West South Central")))),
        br(),
        strong("Map shows the average departure delay greater
than 90 minutes for United States airports from 2008 to 2016. 
Hover over a point to display airport level departure delay.")
               ),
               mainPanel(
                 plotlyOutput('plot3')
               )
             )
    )
)

server <- shinyServer(function(input, output) {
  df_subset <- eventReactive(input$go1, {
    a <- data2 %>% filter(OriginAirport == input$origin 
                          & DestAirport == 
                            input$destination)
    return(a)
  })
  
  df_subset2 <- eventReactive(input$go2, {
    b <- data2 %>% filter(OriginFState == input$originState 
                          & DestFState == 
                            input$destState) %>% 
      arrange(desc(meanDelay))
    return(b)
  })
  
  df_weekend <- eventReactive(input$go, {
    DatCarrier <- data3 %>% filter(year >= input$yearInitial 
                                   & year <= 
                                     input$yearEnd) %>% 
      mutate(yearF = as.factor(year)) %>% 
      dplyr::group_by_("yearF", input$response) %>% 
      dplyr::summarise(MeanDep = mean(dep_delay))
    return(DatCarrier)
  })

  
  output$plot <- renderPlotly({
    withProgress(message = "Application loading", value = 0, {
      dfweek <-  df_weekend()
      incProgress(0.6, detail = "Building plot")
      p = ggplot(dfweek, aes_string(x = "yearF", y = "MeanDep", 
                                    group = input$response, 
                                    color = input$response)) + 
        geom_point() + geom_line(size = 1) + 
        ggtitle(paste("Mean departure delay overtime by", 
                      input$response))
      incProgress(0.4, detail = "Finishing...")
      ggplotly(p)
    })
  })  
  
  output$plot3 <- renderPlotly({
    USAirSum32 <- subset(USAirSum32, year == input$responseM & 
                           Division == input$responseM2)
    USAirSum33 <- USAirSum32
    USAirSum33 <- plyr::rename(USAirSum33, replace = 
                                 c("mean2" = "AverageDelay"))
    g <- list(
      scope = 'usa',
      projection = list(type = 'albers usa'),
      showland = TRUE,
      landcolor = toRGB("gray85"),
      subunitwidth = 1,
      countrywidth = 1,
      subunitcolor = toRGB("white"),
      countrycolor = toRGB("white")
    )
    USAirSum33$AverageDelay <- round(USAirSum33$AverageDelay, 2)
    p <- plot_geo(USAirSum33, locationmode = 'USA-states', 
                  sizes = c(1, 250)) %>%
      add_markers(x = ~ OriginLong, y = ~ OriginLat, 
                  color = ~ AverageDelay, alpha= 0.8,
                  text = ~ paste(OriginFState, "<br />", 
                                 AverageDelay, "<br />", 
                                 OriginAirport)) %>%
      layout(title = (paste('Mean Departure Delay by Airport for', 
                            unique(USAirSum33$year), 'and',
                            unique(USAirSum33$Division))), 
             geo = g)
    #plot_ly(p)
    ggplotly(p)
    #ggplotly(p)
  })
  
  
  datMap2 <- eventReactive(input$go111, {
    group13 <- subset(group12, year == input$responseP & 
                        OriginFState == 
                        input$responseP2 & DestFState == 
                        input$responseP3)
    group13$OriginLong <- round(group13$OriginLong, 4)
    group13$OriginLat <- round(group13$OriginLat, 4)
    
    group13$DestLong <- round(group13$DestLong, 4)
    group13$DestLat <- round(group13$DestLat, 4)
    return(group13)
  })
  
  output$map4 <- renderLeaflet({
    withProgress(message = "Application loading", value = 0, {
      group13 <- datMap2()
      map4 <- leaflet() %>% addTiles()
      incProgress(0.7, detail = "Building plot")
      if (nrow(group13) != 0)
      {
        for (i in 1:nrow(group13))
        {
          long <- cbind(group13[i,"OriginLong"], 
                        group13[i,"DestLong"])
          lat <- cbind(group13[i,"OriginLat"], 
                       group13[i,"DestLat"])
          long1 <- as.list(data.frame(t(long)))
          lat1 <- as.list(data.frame(t(lat)))
          
          map4 <- map4 %>% addTiles(options = 
                    providerTileOptions(noWrap = TRUE)) %>%
            addCircleMarkers(lng = long1$t.long.,
          lat = lat1$t.lat., group='circles', color = "#660099", 
          fillColor = "black", 
          weight = (group13[i,"meanDelay"])/20) %>% 
            addPolylines(lng = long1$t.long., lat = lat1$t.lat., 
                  color = "#660099")
        }
        return(map4)
      }
      else
      {
        return(map4)
      }
      incProgress(0.3, detail = "Finishing...")
    })
  })
  
  observeEvent(input$map4_marker_click,{
    group13 <- datMap2()
    p <- input$map4_marker_click
    clat <- p$lat
    clng <- p$lng
    clat <- round(clat, 4)
    clng <- round(clng, 4)
    group14 <- subset(group13, 
                      (OriginLong == clng & OriginLat == clat) | 
                        (DestLong == clng & DestLat == clat))
    output$latitude <- renderText({return(clat)})
    output$longitude <- renderText({return(clng)})
    group15 <- group14 %>% 
      select(OriginAirport, OriginFState, DestAirport, 
                       DestFState, meanDelay)
    group15 <- plyr::rename(group15, replace = 
                              c("OriginFState" = "OriginState"))
    group15 <- plyr::rename(group15, replace = 
                              c("DestFState" = "DestState"))
    output$lat <- renderDataTable({return(group15)})
  })

  #Midwest plot 
  output$plot34 <- renderPlotly({
    withProgress(message = "Application loading", value = 0, {
      M <- subset(group12, OrigRegion == "Midwest")
      MGroup <- M %>% group_by(OriginFState, year, OrigDivision) %>% 
        summarise(AvgDelay = mean(meanDelay))
      
      MGroup <- plyr::rename(MGroup, replace = 
                               c("OriginFState" = "State"))
      
      MidAt <- subset(MGroup, OrigDivision == "East North Central")
      NewEng <- subset(MGroup, OrigDivision == "West North Central")
      
      incProgress(0.6, detail = "Building plot")
      
      gra <- ggplot(data = MidAt, aes(x=year, y=AvgDelay))  + 
        geom_line(aes(colour = State), size = 1) +
        theme(legend.position="right") + 
        theme(legend.title=element_blank()) +
        theme_fivethirtyeight() + scale_colour_few()
      g <- ggplotly(gra)
      
      
      gra1 <- ggplot(data = NewEng, aes(x=year, y=AvgDelay)) + 
        geom_line(aes(colour = State), size = 1) +
        theme(legend.position="right") + ylab("Year") + 
        theme(legend.title=element_blank()) +
        theme_fivethirtyeight() + scale_colour_few() + 
        xlab("AvgDelay")
      g1 <- ggplotly(gra1)
      
      p <- subplot(g, g1)
      incProgress(0.3, detail = "Finishing...")
      p
    })
  })
  
  
  output$plot35 <- renderPlotly({
    withProgress(message = "Application loading", value = 0, {
      M <- subset(group12, OrigRegion == "Midwest")
      MGroup <- M %>% group_by(OriginFState, year, OrigDivision) %>% 
        summarise(AvgDelay = mean(meanDelay))
      
      MidAt <- subset(MGroup, OrigDivision == "East North Central")
      NewEng <- subset(MGroup, OrigDivision == "West North Central")
      
      incProgress(0.7, detail = "Building plot")
      
      MidAt2 <- MidAt %>% group_by(OriginFState) %>% 
        summarise(AvgDelay = mean(AvgDelay))
      
      NewEng2 <- NewEng %>% group_by(OriginFState) %>% 
        summarise(AvgDelay = mean(AvgDelay))
      
      incProgress(0.3, detail = "Finishing...")
      g2 <- ggplot(MidAt2, aes(x = OriginFState, y = AvgDelay)) + 
        geom_bar(fill="#330033", stat = 'identity', width = 0.4) + 
        theme_fivethirtyeight() + scale_colour_few()
      g2 <- ggplotly(g2)
      g2
      
      g3 <- ggplot(NewEng2, aes(x= OriginFState, y = AvgDelay)) + 
        geom_bar(fill="#330033", stat = 'identity', width = 0.5) + 
        theme_fivethirtyeight() + scale_colour_few()
      g3 <- ggplotly(g3)
      g3
      
      incProgress(0.6, detail = "Finishing...")
      p2 <- subplot(g2, g3)
      p2
    })
  })

output$plot36 <- renderPlotly({
  withProgress(message = "Application loading", value = 0, {
    NE <- subset(group12, OrigRegion == "Northeast")
    NEGroup <- NE %>% group_by(OriginFState, year, OrigDivision) %>% 
      summarise(AvgDelay = mean(meanDelay))
    
    MidAt <- subset(NEGroup, OrigDivision == "Middle Atlantic")
    NewEng <- subset(NEGroup, OrigDivision == "New England")
    
    MidAt <- plyr::rename(MidAt, replace = c("OriginFState" = "State"))
    gra <- ggplot(data = MidAt, aes(x=year, y=AvgDelay)) + 
      geom_line(aes(colour = State), size = 1) + 
      theme(legend.position="right") + 
      theme(legend.title=element_blank()) + theme_fivethirtyeight() +
      scale_colour_few()
    
    incProgress(0.7, detail = "Building plot")
    
    g <- ggplotly(gra)
    g
    
    NewEng <- plyr::rename(NewEng, replace = c("OriginFState" = "State"))
    gra1 <- ggplot(data = NewEng, aes(x=year, y=AvgDelay)) + 
      geom_line(aes(colour = State), size = 1) +
      theme(legend.position="right") + 
      theme(legend.title=element_blank()) + theme_fivethirtyeight() + 
      scale_colour_few()
    
    g1 <- ggplotly(gra1)
    
    incProgress(0.3, detail = "Finishing...")
    subplot(g, g1)
  })
  })

output$plot37 <- renderPlotly({
  withProgress(message = "Application loading", value = 0, {
    NE <- subset(group12, OrigRegion == "Northeast")
    NEGroup <- NE %>% group_by(OriginFState, year, OrigDivision) %>% 
      summarise(AvgDelay = mean(meanDelay))
    
    MidAt <- subset(NEGroup, OrigDivision == "Middle Atlantic")
    NewEng <- subset(NEGroup, OrigDivision == "New England")
    
    MidAt2 <- MidAt %>% group_by(OriginFState) %>% 
      summarise(AvgDelay = mean(AvgDelay))
    
    NewEng2 <- NewEng %>% group_by(OriginFState) %>% 
      summarise(AvgDelay = mean(AvgDelay))
    
    incProgress(0.7, detail = "Building plot")
    
    g2 <- ggplot(MidAt2, aes(OriginFState)) + 
      geom_bar(fill="#330033", aes(weight = AvgDelay), width = 0.4) + 
      theme_fivethirtyeight() + scale_colour_few()
    
    g2 <- ggplotly(g2)
    
    g3 <- ggplot(NewEng2, aes(OriginFState)) + 
      geom_bar(fill="#330033", aes(weight = AvgDelay), width = 0.4) + 
      theme_fivethirtyeight() + scale_colour_few()
    g3 <- ggplotly(g3)
    
    incProgress(0.3, detail = "Finishing...")
    subplot(g2, g3)
  })
})

output$plot38 <- renderPlotly({
  withProgress(message = "Application loading", value = 0, {
    NE <- subset(group12, OrigRegion == "South")
    NEGroup <- NE %>% group_by(OriginFState, year, OrigDivision) %>% 
      summarise(AvgDelay = mean(meanDelay))
    
    NEGroup <- plyr::rename(NEGroup, replace = 
                              c("OriginFState" = "State"))
    
    MidAt <- subset(NEGroup, OrigDivision == "East South Central")
    NewEng <- subset(NEGroup, OrigDivision == "West South Central")
    NewSouth <- subset(NEGroup, OrigDivision == "South Atlantic")
    
    incProgress(0.7, detail = "Building plot")
    
    gra <- ggplot(data = MidAt, aes(x=year, y=AvgDelay)) + 
      geom_line(aes(colour = State), size = 1) +
      theme(legend.position="right") + 
      theme(legend.title=element_blank()) +
      theme_fivethirtyeight() + scale_colour_hue()
    
    g <- ggplotly(gra)
    
    gra1 <- ggplot(data = NewEng, aes(x=year, y=AvgDelay)) + 
      geom_line(aes(colour = State), size = 1) +
      theme(legend.position="right") + 
      theme(legend.title=element_blank()) + 
      theme_fivethirtyeight() + scale_colour_hue()
    
    g1 <- ggplotly(gra1)
    
    gra2 <- ggplot(data = NewSouth, aes(x=year, y=AvgDelay)) + 
      geom_line(aes(colour = State), size = 1) +
      theme(legend.position="right") + 
      theme(legend.title=element_blank()) + 
      theme_fivethirtyeight() + scale_colour_hue()
    g2 <- ggplotly(gra2)
    
    incProgress(0.3, detail = "Finishing...")
    subplot(g, g1, g2)
  })
})

output$plot39 <- renderPlotly({
  withProgress(message = "Application loading", value = 0, {
    NE <- subset(group12, OrigRegion == "South")
    NEGroup <- NE %>% group_by(OriginFState, year, OrigDivision) %>% 
      summarise(AvgDelay = mean(meanDelay))
    
    MidAt <- subset(NEGroup, OrigDivision == "East South Central")
    NewEng <- subset(NEGroup, OrigDivision == "West South Central")
    NewSouth <- subset(NEGroup, OrigDivision == "South Atlantic")
    
    MidAt2 <- MidAt %>% group_by(OriginFState) %>% 
      summarise(AvgDelay = mean(AvgDelay))
    
    NewEng2 <- NewEng %>% group_by(OriginFState) %>% 
      summarise(AvgDelay = mean(AvgDelay))
    
    NewSouth2 <- NewSouth %>% group_by(OriginFState) %>% 
      summarise(AvgDelay = mean(AvgDelay))
    
    incProgress(0.7, detail = "Building plot")
    
    g2 <- ggplot(MidAt2, aes(OriginFState)) + 
      geom_bar(fill="#330033", aes(weight = AvgDelay), width = 0.4) + 
      theme_fivethirtyeight() + scale_colour_few()
    g2 <- ggplotly(g2)
    
    g3 <- ggplot(NewEng2, aes(OriginFState)) + 
      geom_bar(fill="#330033", aes(weight = AvgDelay), width = 0.4) + 
      theme_fivethirtyeight() + scale_colour_few()
    g3 <- ggplotly(g3)
    
    g4 <- ggplot(NewSouth2, aes(OriginFState)) + 
      geom_bar(fill="#330033", aes(weight = AvgDelay), width = 0.4) + 
      theme_fivethirtyeight() + scale_colour_few()
    g4 <- ggplotly(g4)
    
    incProgress(0.3, detail = "Finishing...")
    
    subplot(g2, g3, g4)
  })
})

output$plot40 <- renderPlotly({
  withProgress(message = "Application loading", value = 0, {
    M <- subset(group12, OrigRegion == "West")
    MGroup <- M %>% group_by(OriginFState, year, OrigDivision) %>% 
      summarise(AvgDelay = mean(meanDelay))
    
    MGroup <- plyr::rename(MGroup, replace = c("OriginFState" = "State"))
    
    MidAt <- subset(MGroup, OrigDivision == "Pacific")
    NewEng <- subset(MGroup, OrigDivision == "Mountain")
    
    incProgress(0.6, detail = "Building plot")
    
    gra <- ggplot(data = MidAt, aes(x=year, y=AvgDelay)) + 
      geom_line(aes(colour = State), size = 1) +
      theme(legend.position="right") +  theme(legend.title=element_blank()) + 
      theme_fivethirtyeight() + scale_colour_hue()
    g <- ggplotly(gra)
    
    gra1 <- ggplot(data = NewEng, aes(x=year, y=AvgDelay)) + 
      geom_line(aes(colour = State), size = 1) +
      theme(legend.position="right") +  theme(legend.title=element_blank()) + 
      theme_fivethirtyeight() + scale_colour_hue()
    g1 <- ggplotly(gra1)
    
    incProgress(0.3, detail = "Finishing...")
    subplot(g, g1)
  })
})

output$plot41 <- renderPlotly({
  withProgress(message = "Application loading", value = 0, {
    M <- subset(group12, OrigRegion == "West")
    MGroup <- M %>% group_by(OriginFState, year, OrigDivision) %>% 
      summarise(AvgDelay = mean(meanDelay))
    
    MidAt <- subset(MGroup, OrigDivision == "Pacific")
    NewEng <- subset(MGroup, OrigDivision == "Mountain")
    
    MidAt2 <- MidAt %>% group_by(OriginFState) %>% 
      summarise(AvgDelay = mean(AvgDelay))
    
    NewEng2 <- NewEng %>% group_by(OriginFState) %>% 
      summarise(AvgDelay = mean(AvgDelay))
    
    incProgress(0.6, detail = "Building plot")
    
    g2 <- ggplot(MidAt2, aes(OriginFState)) + 
      geom_bar(fill="#330033", aes(weight = AvgDelay), width = 0.4) + 
      theme_fivethirtyeight() + scale_colour_few()
    g2 <- ggplotly(g2)
    
    g3 <- ggplot(NewEng2, aes(OriginFState)) + 
      geom_bar(fill="#330033", aes(weight = AvgDelay), width = 0.4) + 
      theme_fivethirtyeight() + scale_colour_few()
    g3 <- ggplotly(g3)
    
    incProgress(0.3, detail = "Finishing...")
    subplot(g2, g3)
  })
})
  
  output$plot31 <- renderPlotly({
    withProgress(message = "Application loading", value = 0, {
      group13 <- subset(group12, OriginFState == input$stateDest)
      group14 <- group13 %>% group_by(OriginAirport, year, OriginFState) %>% 
        summarise(AvgDelay = mean(meanDelay))
      group14$OriginAirport <- as.factor(group14$OriginAirport)
      incProgress(0.6, detail = "Building plot")
      plot <- ggplot(data = group14, aes(x=year, y=AvgDelay)) + 
        geom_line(size = 1)  + 
        aes(colour=OriginAirport) + theme(legend.position="none") +
        theme(legend.position="right") + theme_fivethirtyeight() + 
        scale_colour_hue()
      incProgress(0.4, detail = "Finishing...")
      ggplotly(plot)
    })
  })
  
  
  output$plot32 <- renderPlotly({
    withProgress(message = "Application loading", value = 0, {
      group13 <- subset(group12, OriginFState == input$stateDest)
      group14 <- group13 %>% group_by(OriginAirport, year, OriginFState) %>% 
        summarise(AvgDelay = mean(meanDelay))
      group14$OriginAirport <- as.factor(group14$OriginAirport)
      incProgress(0.6, detail = "Building plot")
      group15 <- group14 %>% group_by(year, OriginFState) %>% 
        summarise(AvgDelay = mean(AvgDelay))
      graph <- ggplot(data = group15, aes(x=year, y=AvgDelay)) + 
        geom_line(color = "#330033", size = 1) + 
        labs(title=paste("Departure Delay for", input$stateDest, sep = " ")) + 
        theme_fivethirtyeight() + scale_colour_few()
      incProgress(0.6, detail = "Finishing...")
      ggplotly(graph)
    })
  })
  
  output$view <- renderDataTable(df_subset())
  
  output$avgDelayState <- renderText({
    dataDel <- df_subset2()
    meanDepDelay <- mean(dataDel$meanDelay)
    text <- paste("Average Departure Delay from ", dataDel$OriginFState[1]," to ", 
                  dataDel$DestFState[1], ": ", round(meanDepDelay, 3), sep = "")
    return(text)
  })
  
  output$view2 <- renderDataTable(df_subset2())
  
  output$plot61 <- renderPlotly({
    withProgress(message = "Application loading", value = 0, {
      incProgress(0.6, detail = "Building plot")
      group19 <- group18 %>% group_by(hour, OrigRegion) %>% 
        summarise(AvgDelay = mean(dep_delay))
      r1 <- ggplot(data = group19, aes(x=hour, y=AvgDelay, 
                                       group = OrigRegion)) +
        geom_line(aes(colour = OrigRegion), size = 1) + 
        theme_fivethirtyeight() + scale_colour_few()
      incProgress(0.3, detail = "Finishing...")
      ggplotly(r1)
    })
  })

  output$plot42 <- renderPlotly({
    withProgress(message = "Application loading", value = 0, {
      group20 <- subset(group18, OriginFState == input$stateDest21)
      group20 <- subset(group18, OriginFState == "New York")
      group19 <- group20 %>% group_by(hour) %>% summarise(AvgDelay = 
                                                            mean(dep_delay))
      incProgress(0.6, detail = "Building plot")
      r1 <- ggplot(data = group19, aes(x=hour, y=AvgDelay, group = 1)) + 
        geom_line(size = 1, color = "#330033") + 
        labs(title=paste("Departure Delay for", input$stateDest21, sep = " ")) + 
        theme_fivethirtyeight() + scale_colour_few()
      incProgress(0.4, detail = "Finishing...")
      ggplotly(r1)
    })
  })

  output$plot43 <- renderPlotly({
    withProgress(message = "Application loading", value = 0, {
      group18 <- plyr::rename(group18, replace = c("OrigRegion" = "Region"))
      group19 <- group18 %>% group_by(week, Region) %>% 
        summarise(AvgDelay = mean(dep_delay))
      incProgress(0.6, detail = "Building plot")
      r1 <- ggplot(data = group19, aes(x = week, 
                                       y = AvgDelay, group = Region)) +
        geom_line(aes(colour = Region), size = 1) + 
        theme_fivethirtyeight() + scale_colour_few()
      incProgress(0.4, detail = "Finishing...")
      ggplotly(r1)
    })
  })

  output$plot44 <- renderPlotly({
    withProgress(message = "Application loading", value = 0, {
      group20 <- subset(group18, OriginFState == input$stateDest22)
      group19 <- group20 %>% group_by(week) %>% 
        summarise(AvgDelay = mean(dep_delay))
      incProgress(0.6, detail = "Building plot")
      r1 <- ggplot(data = group19, aes(x=week, y=AvgDelay, group = 1)) +
        geom_line(size = 1, color = "#330033") + 
        labs(title=paste("Departure Delay for", 
                         input$stateDest22, sep = " ")) + 
        theme_fivethirtyeight() + scale_colour_few()
      incProgress(0.4, detail = "Finishing...")
      ggplotly(r1)
    })
  })

  output$plot45 <- renderPlotly({
    withProgress(message = "Application loading", value = 0, {
      group18 <- plyr::rename(group18, replace = c("OrigRegion" = "Region"))
      group19 <- group18 %>% group_by(weekend, Region) %>% 
        summarise(AvgDelay = mean(dep_delay))
      incProgress(0.7, detail = "Building plot")
      r1 <- ggplot(data = group19, aes(x=weekend, 
                                       y=AvgDelay, group = Region)) +
        geom_line(aes(colour = Region), size = 1) + 
        theme_fivethirtyeight() + scale_colour_few()
      incProgress(0.3, detail = "Finishing...")
      ggplotly(r1)
    })
  })

  output$plot46 <- renderPlotly({
    withProgress(message = "Application loading", value = 0, {
      group20 <- subset(group18, OriginFState == input$stateDest23)
      group19 <- group20 %>% group_by(weekend) %>% 
        summarise(AvgDelay = mean(dep_delay))
      incProgress(0.6, detail = "Building plot")
      r1 <- ggplot(data = group19, aes(x=weekend, y=AvgDelay, group = 1)) + 
        geom_line(size = 1, color = "#330033") + 
        labs(title=paste("Departure Delay for", 
                         input$stateDest23, sep = " ")) + 
        theme_fivethirtyeight() + scale_colour_few()
      incProgress(0.6, detail = "Finishing...")
      ggplotly(r1)
    })
  })

  output$plot47 <- renderPlotly({
    withProgress(message = "Application loading", value = 0, {
      group18 <- plyr::rename(group18, replace = c("OrigRegion" = "Region"))
      group19 <- group18 %>% group_by(month, Region) %>% 
        summarise(AvgDelay = mean(dep_delay))
      incProgress(0.6, detail = "Building plot")
      r1 <- ggplot(data = group19, aes(x=month, 
                                       y=AvgDelay, group = Region)) +
        geom_line(aes(colour = Region), size = 1) + 
        theme_fivethirtyeight() + scale_colour_few()
      incProgress(0.4, detail = "Finishing...")
      ggplotly(r1)
    })
  })

  output$plot48 <- renderPlotly({
    withProgress(message = "Application loading", value = 0, {
      group20 <- subset(group18, OriginFState == input$stateDest24)
      group19 <- group20 %>% group_by(month) %>% 
        summarise(AvgDelay = mean(dep_delay))
      incProgress(0.6, detail = "Building plot")
      r1 <- ggplot(data = group19, aes(x=month, y=AvgDelay, group = 1)) + 
        geom_line(size = 1, color = "#330033") + 
        labs(title=paste("Departure Delay for", 
                         input$stateDest24, sep = " ")) + 
        theme_fivethirtyeight() + scale_colour_few()
      incProgress(0.4, detail = "Finishing...")
      ggplotly(r1)
    })
  })

  output$plot49 <- renderPlotly({
    withProgress(message = "Application loading", value = 0, {
      group18 <- plyr::rename(group18, replace = c("OrigRegion" = "Region"))
      group19 <- group18 %>% group_by(season, Region) %>% 
        summarise(AvgDelay = mean(dep_delay))
      incProgress(0.6, detail = "Building plot")
      r1 <- ggplot(data = group19, aes(x=season, 
                                       y=AvgDelay, group = Region)) +
        geom_line(aes(colour = Region), size = 1) + 
        theme_fivethirtyeight() + scale_colour_few()
      incProgress(0.4, detail = "Finishing...")
      ggplotly(r1)
    })
  })

  output$plot50 <- renderPlotly({
    withProgress(message = "Application loading", value = 0, {
      group20 <- subset(group18, OriginFState == input$stateDest25)
      group19 <- group20 %>% group_by(season) %>% 
        summarise(AvgDelay = mean(dep_delay))
      incProgress(0.6, detail = "Building plot")
      r1 <- ggplot(data = group19, aes(x=season, 
                                       y=AvgDelay, group = 1)) + 
        geom_line(size = 1, color = "#330033") + 
        labs(title=paste("Departure Delay for", 
                         input$stateDest25, sep = " ")) + 
        theme_fivethirtyeight() + scale_colour_few()
      incProgress(0.4, detail = "Finishing...")
      ggplotly(r1)
    })
  })

  output$plot51 <- renderPlotly({
    withProgress(message = "Application loading", value = 0, {
      group18 <- plyr::rename(group18, replace = c("OrigRegion" = "Region"))
      group19 <- group18 %>% group_by(carrier, Region) %>% 
        summarise(AvgDelay = mean(dep_delay))
      incProgress(0.6, detail = "Building plot")
      r1 <- ggplot(data = group19, aes(x=carrier, 
                                       y=AvgDelay, group = Region)) +
        geom_line(aes(colour = Region), size = 1) + 
        theme_fivethirtyeight() + scale_colour_few()
      incProgress(0.4, detail = "Finishing...")
      ggplotly(r1)
    })
  })

  output$plot52 <- renderPlotly({
    withProgress(message = "Application loading", value = 0, {
      group20 <- subset(group18, OriginFState == input$stateDest26)
      group19 <- group20 %>% group_by(carrier) %>% 
        summarise(AvgDelay = mean(dep_delay))
      incProgress(0.6, detail = "Building plot")
      r1 <- ggplot(data = group19, aes(x=carrier, 
                                       y=AvgDelay, group = 1)) + 
        geom_line(size = 1, color = "#330033") + 
        labs(title=paste("Departure Delay for", 
                         input$stateDest26, sep = " ")) + 
        theme_fivethirtyeight() + scale_colour_few()
      incProgress(0.4, detail = "Finishing...")
      ggplotly(r1)
    })
  })
  
})

shinyApp(ui = ui, server = server)
```


####Web Scraping for Airport and State Names
```{r, eval = FALSE}
library(rvest)
lego_movie1 <- read_html("http://www.airportcodes.us/us-airports-
by-state.htm")
dat2 <- html_nodes(lego_movie, ".c td")
airportText <- html_text(dat2)
airportText2 <- as.data.frame(airportText)
airportText2$airportText <- as.character(airportText2$airportText)

array2 = list()
for (i in 1:nrow(airportText2))
{
if (nchar(airportText2[i, ]$airportText) == 2)
{
array2 = c(array2, i)
}
}
num <- c(1:2905)
array3 <- unlist(array2)
states2 <- data.frame(code = airportText2[array3, ])

array4 = list()
for (i in 1:nrow(airportText2))
{
if (nchar(airportText2[i, ]$airportText) == 3)
{
array4 = c(array4, i)
}
}
array4 <- unlist(array4)
counties <- data.frame(code = airportText2[array4, ])
diffStates <- setdiff(num, array3)
diffStates2 <- setdiff(diffStates, array4)

#get airports (3 letter code + 1 indices)
code.numAir <- counties$code.num + 1
code.numStates <- counties$code.num - 2
airports <- data.frame(code = airportText2[code.numAir, ])
states2 <- data.frame(code = airportText2[code.numStates, ])
dataAir <- cbind(states2, counties, airports)
AirData <- dataAir[, c(1, 3, 5)]
ld <- load("GroupedDest.Rda")
head(GroupedDest)
Origin <- GroupedDest$origin
Origin <- as.data.frame(Origin)
Origin$Origin <- as.character(Origin$Origin)
OriginMerge <- inner_join(Origin, AirData,
by = c("Origin" = "code.airportText.1"))
OriginMerge #includes the airport

Dest <- GroupedDest$dest
Dest <- as.data.frame(Dest)
Dest$Dest <- as.character(Dest$Dest)
DestMerge <- inner_join(Dest, AirData,
by = c("Dest" = "code.airportText.1"))
save(OriginMerge, file = "OriginMergeData.Rda")
save(DestMerge, file = "DestMergeData.Rda")

orig <- load("OriginMergeData.Rda")
dest <- load("DestMergeData.Rda")
group <- load("GroupedDest.Rda")

library(dplyr)
OriginMerge <- rename(OriginMerge, OriginState = code.airportText)
OriginMerge <-
rename(OriginMerge, OriginAirport = code.airportText.2)

DestMerge <- rename(DestMerge, DestState = code.airportText)
DestMerge <- rename(DestMerge, DestAirport = code.airportText.2)
head(GroupedDest)

OriginJoin <- inner_join(OriginMerge, GroupedDest,
by = c("Origin" = "origin"))
OriginJoin2 <- inner_join(OriginJoin, DestMerge,
by = c("dest" = "Dest"))
unOrigin <- unique(OriginJoin2)
save(unOrigin, file = "AirlinesFull.Rda")
air <- load("AirlinesFull.Rda")
head(unOrigin)

library(rvest)
lego_movie2 <-
read_html("http://www.50states.com/abbreviations.htm")
dat3 <- html_nodes(lego_movie2, "td")
airportText3 <- html_text(dat3)
airportText3 <- as.data.frame(airportText3)
airportText3$airportText3 <- as.character(airportText3$airportText3)

numSt <- c(1:130)
statelist = list()
for (i in 1:nrow(airportText3))
{
if (nchar(airportText3[i, ]) == 2)
{
statelist = c(statelist, i)
}
}
statelist <- unlist(statelist)
head(airportText3)
stateCode <- data.frame(code = airportText3[statelist, ])
stateName <- setdiff(numSt, statelist)
stateName2 <- data.frame(code = airportText3[stateName,])

statesName <- cbind(stateCode, stateName2)
statesToMerge <- statesName[1:50, ]
head(statesToMerge)

statesToMerge$stateName <- statesToMerge$code
substates <- statesToMerge[, c(2, 3)]
unOrigin$OriginState <- as.character(unOrigin$OriginState)
substates$stateName <- as.character(substates$stateName)
stateFin1 <- (unOrigin %>% inner_join(substates,
by = c("OriginState" = "stateName")))
substates <- rename(substates, DestName = stateName)
stateFin2 <- (stateFin1 %>% inner_join(substates,
by = c("DestState" = "DestName")))
head(stateFin2)
stateFin2 <- rename(stateFin2, OriginFState = code.x)
stateFin2 <- rename(stateFin2, DestFState = code.y)
save(stateFin2, file = "airportFullDat.Rda")
```


